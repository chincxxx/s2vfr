<!DOCTYPE html>
<html>
  <head>
    <title> Conceptual Metaphor Project </title>
    <link href="https://unpkg.com/jspsych@7.0.0/css/jspsych.css" rel="stylesheet" type="text/css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/bowser@2.5.3/es5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/svg.js/2.6.3/svg.min.js"></script>
    <script src="jsPsych-6.3.1/jspsych.js"></script>
    <script src="jsPsych-6.3.1/plugin-html-keyboard-response.js"></script> 
    <script src="jsPsych-6.3.1/plugin-html-button-response.js"></script>
    <script src="jsPsych-6.3.1/plugin-preload.js"></script>
    <script src="jsPsych-6.3.1/plugin-fullscreen.js"></script>
    <script src="jsPsych-6.3.1/plugin-survey-multi-choice.js"></script>
    <script src="jsPsych-6.3.1/plugin-survey-text.js"></script>
    <script src="jsPsych-6.3.1/plugin-virtual-chinrest.js"></script>
    <script src="https://brain2ai.github.io/jsPsychSheet/jspsychsheet.js"></script> 
    <link rel="stylesheet" href="https://brain2ai.github.io/jsPsychSheet/jspsychsheet.css">

    <style> 
      #topText {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px;
            z-index: 1000; 
            font-size: 24px/* Ensures it is on top of other elements */
        }
      #bottomText {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px;
            z-index: 1000;
            font-size: 24px/* Ensures it is on top of other elements */
        }
      .blue-line{
        color:blue
      }
      .red-line{
        color:red
      }
      @keyframes fadeIn{
        from {opacity: 0;}
        to {opacity: 1;}
      }
      .jspsych-display-element{
        font-size: 24px
      }
      .jspsych-btn{
        font-size: 24px
      }
    </style>
  </head>
  <body></body>
  <script>

    const jsPsych = initJsPsych();

    //stimuli lists
    var A1 = ["a1_1", "a1_2", "a1_3", "a1_4"]
    var A2 = ["a2_1", "a2_2","a2_3","a2_4"]
    var A3 = ["a3_1", "a3_2", "a3_3", "a3_4"]
    var A4= ["a4_1", "a4_2", "a4_3","a4_4"]
    var A5= ["a5_1", "a5_2", "a5_3", "a5_4"]
    var A6= ["a6_1", "a6_2", "a6_3", "a6_4"]
    var A7= ["a7_1", "a7_2", "a7_3", "a7_4"]
    var A8= ["a8_1", "a8_2", "a8_3", "a8_4"]
    var A9= ["a9_1", "a9_2", "a9_3"]
    var A10 = ["a10_1", "a10_2", "a10_3", "a10_4"]
    var A11= ["a11_1", "a11_2", "a12_3", "a12_4"]
    var A12= ["a12_1", "a11_2", "a12_3", "a12_4"]
    var B1 = ["b1_1", "b1_2", "b1_3", "b1_4"]
    var B2 = ["b2_1", "b2_2", "b2_3", "b2_4"]
    var B3 = ["b3_1", "b3_2", "b3_3", "b3_4"]
    var B4= ["b4_1", "b4_2", "b4_3", "b4_4"]
    var B5= ["b5_1", "b5_2", "b5_3", "b5_4"]
    var B6= ["b6_1", "b6_2", "b6_3", "b6_4"]
    var B7= ["b7_1", "b7_2", "b7_3"]
    var B8= ["b8_1", "b8_2", "b8_3", "b8_4"]
    var B9= ["b9_1", "b9_2", "b9_3", "b9_4"]
    var B10 = ["b10_1", "b10_2", "b10_3"]
    var B11= ["b11_1", "b11_2", "b11_3", "b11_4"]
    var B12= ["b12_1", "b12_2", "b12_3", "b12_4"]
    var C1 = ["c1_1", "c1_2", "c1_3", "c1_4"]
    var C2 = ["c2_1", "c2_2", "c2_3", "c2_4"]
    var C3 = ["c3_1", "c3_2", "c3_3", "c3_4"]
    var C4= ["c4_1", "c4_2", "c4_3"]
    var C5= ["c5_1", "c5_2", "c5_3", "c5_4"]
    var C6= ["c6_1", "c6_2", "c6_3", "c6_4"]
    var C7= ["c7_1", "c7_2", "c7_3", "c7_4"]
    var C8= ["c8_1", "c8_2", "c8_3", "c8_4"]
    var C9= ["c9_1", "c9_2", "c9_3", "c9_4"]
    var C10 = ["c10_1", "c10_2", "c10_3"]
    var C11= ["c11_1", "c11_2", "c11_3", "c11_4"]
    var C12= ["c12_1", "c12_2", "c12_3", "c12_4"]

    var buffer_list = ["b9_1","b5_4","究竟为什么","就这里buffer则么号码"]
    var practice_list = ["你好c", "这里c", "可能b","无语c","好吃b","天啊c"]
    var experiment_list= [...A1, ...A7]
    console.log(buffer_list)
    console.log(practice_list)
    console.log(experiment_list)



    var timeline = []
    var n_blocks = 2; 
    var n_trials = buffer_list.length+practice_list.length+experiment_list.length; //total num of trials
    var trialnum = 0;
		var blocknum = 0
    


    //INPUT from participants 
    var idnum = jsPsych.data.getURLVariable('idnum')
    var soa = parseInt(jsPsych.data.getURLVariable('soa'))
    
    //var idnum = 3
    //var soa = 200

    var soa_duration = soa-150
    var key_assignment, key_text
    if (idnum % 2 === 0) {
      key_assignment = "posRight";
      key_text = `
      <p>In this part of the experiment, we are looking at how people make simple but quick judgments. 
      For each trial, you will see a brief presentation of a traditional Chinese compound word.</p>
      <p class="blue-line"><b>Your job is to judge the valence of the word (the emotion it expresses).</b></p>
      <p><b>Each word will remain on the screen for a brief time. 
      When prompted, you should respond by indicating whether you think the 
      word you saw expresses positive or negative.</b></p>
      <p class="red-line"><b>If it's a <u>positive word</u>, press the 'A' key.</b></p>
      <p class="red-line"><b>If it's a <u>negative word</u>, press the 'L' key.</b></p>
      <p>When the study is fully loaded, the button below will activate. 
      Click it to indicate you have read these instructions, and are ready 
      to continue to the second page of instructions. 
      (Refresh the page if the button does not become active.)</p>
      <p><i><u><b>Please only proceed after you have CAREFULLY read these instructions 
      and are definitely sure that you are ready!</i></u></b></p>`} 
    else {
      key_assignment = "posLeft";
      key_text = `
      <p>In this part of the experiment, we are looking at how people make simple but quick judgments. 
      For each trial, you will see a brief presentation of a traditional Chinese compound word.</p>
      <p class="blue-line"><b>Your job is to judge the valence of the word (the emotion it expresses).</b></p>
      <p><b>Each word will remain on the screen for a brief time. 
      When prompted, you should respond by indicating whether you think the 
      word you saw expresses positive or negative.</b></p>
      <p class="red-line"><b>If it's a <u>negative word</u>, press the 'A' key.</b></p>
      <p class="red-line"><b>If it's a <u>positive word</u>, press the 'L' key.</b></p>
      <p>When the study is fully loaded, the button below will activate. 
      Click it to indicate you have read these instructions, and are ready 
      to continue to the second page of instructions. 
      (Refresh the page if the button does not become active.)</p>
      <p><i><u><b>Please only proceed after you have CAREFULLY read these instructions 
      and are definitely sure that you are ready!</i></u></b></p>`
    }

    //var positions_pre = ["<p style='vertical-align:384px'>", "<p style='vertical-align:-384px'>"] 
    var positions_pre = ["topText", "bottomText"]
    var experiment_positions_pre, buffer_positions_pre, practice_positions_pre
    if (experiment_list.length % 2 === 0) {
      experiment_positions_pre = jsPsych.randomization.repeat(positions_pre, experiment_list.length/positions_pre.length);} 
    else {
      experiment_positions_pre = [...jsPsych.randomization.repeat(positions_pre, (experiment_list.length - 1)/positions_pre.length)]
    }
    buffer_positions_pre = jsPsych.randomization.repeat(positions_pre, 1)
    practice_positions_pre = jsPsych.randomization.repeat(positions_pre, 3)
console.log(experiment_list)
console.log(practice_positions_pre)
console.log(buffer_positions_pre)
console.log(experiment_positions_pre)

var current_positions_pre

var i, j, k
var exp_stim_pos = []
var prac_stim_pos = []
var buff_stim_pos = []
for (let k = 0; k < buffer_list.length; k++) {
      buff_stim_pos.push({ current_positions_pre: buffer_positions_pre[k], current_stimuli: buffer_list[k] });
    }
for (let i = 0; i < experiment_list.length; i++) {
      exp_stim_pos.push({ current_positions_pre: experiment_positions_pre[i], current_stimuli: experiment_list[i] });
}
for (let j = 0; j < practice_list.length; j++) {
      prac_stim_pos.push({ current_positions_pre: practice_positions_pre[j], current_stimuli: practice_list[j] });
}

console.log(buff_stim_pos)


///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		var instruction_1 = {
      type: jsPsychHtmlButtonResponse,
      data: { screen: "instruction_1" },
			stimulus: `
          <p>Hello, we are interested in xxxxxxxx (remember to fill in text)! 
          When you are ready to start the experiment please press start to begin. 
          You can continue in 3 seconds.</p>`,
			choices: ["Click to continue"],
      on_load: () => {
        document.querySelector('button').disabled = true;
        setTimeout(() => { document.querySelector('button').disabled = false}, 3000)
      }
		};
		timeline.push(instruction_1);

    var fullscreen_on = {
      type: jsPsychFullscreen,
      data: { screen: "fullscreen_on" },
      fullscreen_mode: true
    } 
    timeline.push(fullscreen_on);

    var instruction_2 = { //key assignment is different 
      type: jsPsychHtmlButtonResponse,
      data: { screen: "instruction_2" },
			stimulus: key_text,
			choices: ["Click to continue"]
		};

    var instruction_3 = {
      type: jsPsychHtmlButtonResponse,
      data: { screen: "instruction_3" },
			stimulus: `
      <p> We will now first do some practice trials. </p>
      `,
			choices: ["Click to continue"],
      on_finish: function(data){
        blocknum = -1
        trialnum = 0
        jsPsych.data.addProperties({
          idnum: idnum,
          soa: soa,
          key_assignment: key_assignment
        });
      }
		};
		timeline.push(instruction_3);
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////





    var fixation = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `<div>+++</div>`,
      choices: "NO_KEYS",
      trial_duration: 500,
      on_finish: function(data){
        data.screen = "fixation"
        data.blocknum = blocknum // pass from instr_1: blocknum=-1
        data.trialnum = trialnum
      }
    }

    //var cross_positions
    var trial_types
    
    //"<p style='vertical-align:"+current_positions_pre+"'> +++ </p>"
    var position_fixation = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: function(){
        current_positions_pre = jsPsych.timelineVariable("current_positions_pre")
        var full_pos = '<div id='+current_positions_pre+'> +++ </div>';
        //`<div id="topText">+++</div>`
        console.log(full_pos)
        return (full_pos)
      },
      choices: "NO_KEYS",
      trial_duration: 150,
      on_finish: function(data){
        data.screen = "position_fixation"
        data.blocknum = blocknum 
        data.trialnum = trialnum
        data.current_positions_pre = current_positions_pre
      }
    }
    var blank_soa = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: "",
      choices: "NO_KEYS",
      trial_duration: soa_duration,
      on_finish: function(data){
        data.screen = "blank_soa"
        data.blocknum = blocknum 
        data.trialnum = trialnum
        data.soa_duration = soa_duration
      }
    }



    var current_stimuli, stimuli_positions, full_stim
    var stim = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: function(){
        current_positions_pre = jsPsych.timelineVariable("current_positions_pre")
        current_stimuli = jsPsych.timelineVariable("current_stimuli")
        var full_stim = '<div id='+current_positions_pre+'>' + current_stimuli + '</div>';
        console.log(full_stim)


        if (experiment_list.includes(current_stimuli)){
          trial_types = "experiment_trial"
        }
        else if (practice_list.includes(current_stimuli)){
          trial_types = "practice_trial"
        }
        else if (buffer_list.includes(current_stimuli)){
          trial_types = "buffer_trial"
        }
        return (full_stim)
    }, /////////////////////////3000 ms
      choices: ["a", "l"],
      trial_duration: 3000,
      on_finish: function(data){
        data.screen = "stim"
        data.blocknum = blocknum 
        data.trialnum = trialnum
        data.current_positions_pre = current_positions_pre
        data.current_stimuli = current_stimuli
        data.trial_types = trial_types
      }
    }


    var interval = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: function(){
        current_stimuli = jsPsych.timelineVariable("current_stimuli")
        if (practice_list.includes(current_stimuli)){
          return ('')
        } else { 
          return ('')
        }
      },
      choices: "NO_KEYS",
      trial_duration: 1500,
      on_finish: function(data){
        data.screen = "interval"
        data.blocknum = blocknum 
        data.trialnum = trialnum
        data.current_positions_pre = current_positions_pre
        data.current_stimuli = current_stimuli
        data.trial_types = trial_types
        trialnum += 1
      }
    }
    
    

    var practice_block = {
      timeline: [fixation, position_fixation, blank_soa, stim, interval], 
      timeline_variables: prac_stim_pos, 
      randomize_order: true
    }
    var buffer_block = {
      timeline: [fixation, position_fixation, blank_soa, stim, interval], 
      timeline_variables: buff_stim_pos, 
      randomize_order: true
    }
    var experiment_block = {
      timeline: [fixation, position_fixation, blank_soa, stim, interval], 
      timeline_variables: exp_stim_pos, 
      randomize_order: true
    }

    timeline.push(practice_block)


    var instruction_4 = {
      type: jsPsychHtmlButtonResponse,
      stimulus: "Ready to begin? The experiment will start on the next page.<br><br>",
      choices: ["Start"],
      data: { screen: "instruction_4" },
      on_finish: function(data){
        blocknum = 0 
        trialnum = 0
      }
    };
    timeline.push(instruction_4)

    //var rest = {
      //type: "html-keyboard-response",
      //stimulus: function(){

        //where we are in the whole process
        //var progress = Math.round(trialnum/n_trials*(blocknum+1)*100/n_blocks) //return whole number
        //return ("You have completed " + progress + "% of the experiment.<br><br>" +
              //"When you are ready, press <b>SPACEBAR</b> to continue.<br><br>")
      //},
      //choices: [' '], //space bar
      //response_ends_trial: true,
      //data: { screen: "break" },
      //on_finish: function(){
        //trialnum = 0
        //blocknum += 1; //after the break, blocknum = blocknum+ 1
      //}
    //}

    //whether rest or not
    //var rest_if = {
      //timeline: [rest], //include rest here, so we don't have to push rest to the bigger timeline
      //conditional_function: function(){

        //if (1)trial is half way through/complete and (2)haven't rest yet
        //which leaves only 'half way through'
        //if(((trialnum % (n_trials/2)) == 0) & (trialnum*(blocknum+1)!=n_trials*2)){
            //return true; //rest
        //} else {
            //return false; //no rest
        //}
      //}
    //};
    
    timeline.push(buffer_block)
    timeline.push(experiment_block)
    
    //var p
    //for (p = 0; p < n_blocks; p++) {
      //timeline.push(experiment_block) //push this whole experiment 2 times (before rest & after rest)
    //}





    var thankyou = {
      type: jsPsychHtmlButtonResponse,
      data: { screen: "thankyou_page" },
			stimulus: `
          <p>Thank you for your participation! Please click to finish. </p>`,
			choices: ["Click to finish"]
		}
    timeline.push(thankyou)
    
    var fullscreen_off = {
      type: jsPsychFullscreen,
      fullscreen_mode: false,
      data: {screen: "fullscreen_off"},
      on_finish: function(){
        //xxxxx console.log(jsPsych.data.get().filter({screen: 'stim'}).csv()); xxxxx//track    
        jsPsych.data.get().filter({screen: 'stim'}).localSave('csv',idnum.toString()+'.csv')}
  } 
    timeline.push(fullscreen_off)

    jsPsych.run(timeline);

    </script>
</html>
